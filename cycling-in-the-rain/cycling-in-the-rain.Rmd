# STATS 763: Assignment 1: Cycling in the Rain
### Tarin Eccleston
### 07/08/2024

```{r results='hide', warning=FALSE, message=FALSE, error=FALSE}
library(tidyverse)
library(geosphere)
```

#### Data Manipulation

Based on the brief, we would like these columns in out dataframe for modelling:

- cycle_count
- weighted_average_rainfall
- cycle_recording_sites
- lockdown
- year
- season
- day_of_week
- date

##### Read Data

```{r results='hide', warning=FALSE, message=FALSE, error=FALSE}
ac_2018 <- read_csv("data/aucklandcyclists2018.csv")
ac_2019 <- read_csv("data/aucklandcyclists2019.csv")
ac_2020 <- read_csv("data/aucklandcyclists2020.csv")
ac_2021 <- read_csv("data/aucklandcyclists2021.csv")
ac_2022 <- read_csv("data/aucklandcyclists2022.csv")

monitoring_locations <- read.csv("data/monitoringlocations.csv")

daily_rainfall <- read.csv("data/daily-rainfall-at-30-sites-1960-to-2022.csv")
daily_rainfall_data_dict <- read.csv("data/daily-rainfall-at-30-sites-1960-to-2022-dictionary.csv")
```

##### Standardise Date Format

We need all date formats to be in YYYY-MM-DD, and as date objects.

```{r}
ac_2018 <- ac_2018 %>%
  mutate(date = as.Date(Date, format = "%Y-%m-%d")) %>%
  select(-Date)

ac_2019 <- ac_2019 %>%
  mutate(date = dmy(str_remove(Date, "^[A-Za-z]+,\\s*"))) %>%
  mutate(date = as.Date(Date, format = "%Y-%m-%d")) %>%
  select(-Date)

ac_2020 <- ac_2020 %>%
  mutate(date = dmy(str_remove(Date, "^[A-Za-z]+\\s+"))) %>%
  mutate(date = as.Date(date, format = "%Y-%m-%d")) %>%
  select(-Date)

ac_2021 <- ac_2021 %>%
  mutate(date = as.Date(Date, format = "%Y-%m-%d")) %>%
  select(-Date)

ac_2022 <- ac_2022 %>%
  mutate(date = as.Date(Date, format = "%Y-%m-%d")) %>%
  select(-Date)
```

##### Pivot data and Merge

```{r}
ac_2018 <- ac_2018 %>%
  pivot_longer(cols = -date, names_to = "cycle_recording_site", values_to = "cycle_count") %>%
  drop_na(cycle_count)

ac_2019 <- ac_2019 %>%
  pivot_longer(cols = -date, names_to = "cycle_recording_site", values_to = "cycle_count") %>%
  drop_na(cycle_count)

ac_2020 <- ac_2020 %>%
  pivot_longer(cols = -date, names_to = "cycle_recording_site", values_to = "cycle_count") %>%
  drop_na(cycle_count)

ac_2021 <- ac_2021 %>%
  pivot_longer(cols = -date, names_to = "cycle_recording_site", values_to = "cycle_count") %>%
  drop_na(cycle_count)

ac_2022 <- ac_2022 %>%
  pivot_longer(cols = -date, names_to = "cycle_recording_site", values_to = "cycle_count") %>%
  drop_na(cycle_count)

ac <- rbind(ac_2018, ac_2019, ac_2020, ac_2021, ac_2022)
ac %>% str
```

We drop all NAs. It would be difficult to impute, and we already have quite a bit of data. Though the missing data could have an effect on biasing our estimates.

##### Filter for important rainfall data

Two of the rainfall monitoring locations are relevant to Auckland: "Auckland (Auckland)", close to the airport, and "Whangaparāoa (Auckland)".

We only need need rainfall data corresponding to cycling data between 2018-01-01 and 2022-12-31.

```{r}
daily_rainfall_auckland <- daily_rainfall %>%
  filter(site == "Auckland (Auckland)") %>%
  mutate(date = as.Date(date, format = "%Y-%m-%d")) %>%
  filter(date >= as.Date("2018-01-01"))

daily_rainfall_whangaparaoa <- daily_rainfall %>%
  filter(site == "Whangaparāoa (Auckland)") %>%
  mutate(date = as.Date(date, format = "%Y-%m-%d")) %>%
  filter(date >= as.Date("2018-01-01"))
```

##### Get Distances between Rainfall Stations and Cycle Recording Sites

```{r}
auckland_rainfall_station_coordinates <- data_frame(
  lat = -37.00813,
  lon = 174.7887
)

whangaparaoa_rainfall_station_coordinates <- data_frame(
  lat = -36.606,
  lon = 174.835
)

rainfall_stations_to_cycle_recording_sites <- data_frame(cycle_recording_site = monitoring_locations$Location)

rainfall_stations_to_cycle_recording_sites <- rainfall_stations_to_cycle_recording_sites %>%
  mutate(distance_to_auckland = pmap_dbl(
    list(lat = monitoring_locations$Latitude, lon = monitoring_locations$Longitude),
    ~ distHaversine(c(..2, ..1), c(auckland_rainfall_station_coordinates$lon, auckland_rainfall_station_coordinates$lat))
  )) %>%
  mutate(distance_to_whangaparaoa = pmap_dbl(
    list(lat = monitoring_locations$Latitude, lon = monitoring_locations$Longitude),
    ~ distHaversine(c(..2, ..1), c(whangaparaoa_rainfall_station_coordinates$lon, whangaparaoa_rainfall_station_coordinates$lat))
  ))

rainfall_stations_to_cycle_recording_sites %>% str
```

##### Calculate Weighted Average Rainfall by Relative Distances between Rainfall Stations and Cycle Recording Sites

```{r}
ac <- ac %>%
  left_join(rainfall_stations_to_cycle_recording_sites, by = "cycle_recording_site") %>%
  left_join(daily_rainfall_auckland %>% select(date, rainfall) %>% rename(rainfall_auckland = rainfall), by = "date") %>%
  left_join(daily_rainfall_whangaparaoa %>% select(date, rainfall) %>% rename(rainfall_whangaparaoa = rainfall), by = "date") %>%
  mutate(weighted_average_rainfall = (rainfall_auckland / distance_to_auckland + rainfall_whangaparaoa / distance_to_whangaparaoa) /
                        (1 / distance_to_auckland + 1 / distance_to_whangaparaoa)) %>%
  select(-c(distance_to_auckland, distance_to_whangaparaoa, rainfall_auckland, rainfall_whangaparaoa))
  
```

Another approach would be to find the closest rainfall station and use those measurements for that day at that cycle recording site. However, I believe using the weighted average between the two rainfall stations in Auckland weighted by their relative distances to the cycle recording sites is the best approach as it balances out bias created from having rainfall measurements taken at a vastly different location to the cycle recording sites.

##### Find Day of the Week

```{r}

```

##### Find Season

```{r}

```


##### Create flag for Lockdown period

```{r}

```

#### Exploratory Analysis

##### Todo: Causal Diagram

```{r}

```

